name: CheckPlan to Develop
on:
  pull_request:
    branches: [develop]

env:
  PREFIJO: sbc-pruebas-dev
  POSTFIJO: deploy-lambda
  BUCKET: bucket-pruebas-juanfelipe
  LAMBDAFUNCTION: JuanFelipePruebas
  REGION: us-east-1

jobs:
    deploy:
        name: "CheckPlan"
        runs-on: ubuntu-latest
        env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_DEVELOP }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEVELOP }}            
 
        steps:
          - name: Checkout Code
            uses: actions/checkout@v2

          - name: Setup Python
            uses: actions/setup-python@v2

          - name: Update Python AWS Cli
            run:  python3 -m pip install --user awscli

 
          - name: Package Lambdas to zip
            id: Package_Lambdas
            run:  |
                  for dir in */; do
                    echo "----"
                    echo "$dir"
                    cd $dir
                    mkdir -p "$PREFIJO-${dir%?}-$POSTFIJO"
                    cd src
                    pip install -r ../config/requirements.txt -t ../"$PREFIJO-${dir%?}-$POSTFIJO"
                    cd ..
                    cp -r src/* "$PREFIJO-${dir%?}-$POSTFIJO"
                    cd "$PREFIJO-${dir%?}-$POSTFIJO"
                    zip -r ../"$PREFIJO-${dir%?}-$POSTFIJO.zip" .
                    cd ..
                  done
                  
          - name: Upload Lambdas to S3
            id: Upload_Lambdas_to_S3
            run:  |
                for dir in */; do
                  echo "----"
                  echo "$dir"
                  cd $dir
                  #aws s3 --region $REGION cp "$PREFIJO-${dir%?}-$POSTFIJO.zip" s3://$BUCKET
                done
          

          - name: Update Lambda Code from S3
            id: Update_lambda_code_from_S3
            run: |                
                for dir in */; do                
                  #aws lambda update-function-code --region $REGION --function-name $LAMBDAFUNCTION --s3-bucket $BUCKET --s3-key "$PREFIJO-${dir%?}-$POSTFIJO.zip"
                  sleep 5s
                done



          - name: Update Lambda Configuration
            id: Update_lambda_configuration
            run: |                             
                cd login/config                              
                mkdir -p "lambdas_temp"
                ls
                sudo apt install libghc-yaml-dev
                yaml2json file.yaml                
                #cat "config.yml" | yq > config.json
                #cat config.json
                #cantidad_lambdas=$(jq '.lambdas | length' config.json)
                #echo "cantidad lambdas $cantidad_lambdas"
                
                #for ((i = 0; i < $cantidad_lambdas; i++)); do
                #        echo "creado archivo json $i"
                #        cat config.json | jq '.lambdas['$i']' > "lambdas_temp/lambda_$i.json"
                #        aws lambda update-function-configuration --cli-input-json file://lambdas_temp/lambda_$i.json
                #done                

          #- name: Update Lambda Configuration
          #  id: Update_lambda_configuration
          #  run: | 
          #      AWS_COMMAND="aws lambda update-function-configuration --region $REGION --function-name $LAMBDAFUNCTION"
          #      while IFS= read -r line; do           
          #        if [ -n "$line" ]; then                  
          #          AWS_COMMAND="$AWS_COMMAND $line"
          #        fi
          #      done < login/config/configlambda.txt                           
          #      echo "Ejecutando comando= $AWS_COMMAND"       
                #$AWS_COMMAND
                      
                


